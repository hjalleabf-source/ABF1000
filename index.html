<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ABF Dalarna Statistik</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      text-align: center;
    }

    header {
      background: #fff;
      color: #d71920;
      padding: 20px;
      font-size: 2rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px; /* minskat mellanrum */
    }

    section {
      padding: 35px 15px;
    }

    .goal {
      font-size: 3.5rem; /* större rubrik 1 */
      font-weight: 700;
      margin: 0 0 10px 0;
    }

    .subtitle {
      font-size: 1.2rem;
      margin: 5px 0;
      text-transform: uppercase;
    }

    .today-label, .percent-label {
      font-size: 1rem;
      margin: 12px 0 5px;
    }

    .today-number, .percent-number {
      font-size: 2.5rem; /* samma storlek som tidigare */
      font-weight: 700;
      margin: 0;
    }

    /* Blockfärger */
    #studiecirklar-block {
      background: #d71920; /* röd */
      color: #fff;
    }

    #kulturprogram-block {
      background: #fff;
      color: #d71920;
    }

    #folkbildning-block {
      background: #1ba6ab; /* turkos */
      color: #fff;
    }

    #errors {
      color: #900;
      margin: 15px 0;
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    ABF DALARNA
  </header>

  <!-- BLOCK 1 -->
  <section id="studiecirklar-block">
    <div class="goal">1000</div>
    <div class="subtitle">Studiecirklar</div>
    <div class="today-label">Studiecirklar idag</div>
    <div class="today-number" id="Studiecirklar">–</div>
    <div class="percent-label">Procent av målet</div>
    <div class="percent-number" id="Studiecirklar_percent">–</div>
  </section>

  <!-- BLOCK 2 -->
  <section id="kulturprogram-block">
    <div class="goal">1000</div>
    <div class="subtitle">Kulturprogram</div>
    <div class="today-label">Kulturprogram idag</div>
    <div class="today-number" id="Kulturprogram">–</div>
    <div class="percent-label">Procent av målet</div>
    <div class="percent-number" id="Kulturprogram_percent">–</div>
  </section>

  <!-- BLOCK 3 -->
  <section id="folkbildning-block">
    <div class="goal">500</div>
    <div class="subtitle">Annan folkbildning</div>
    <div class="today-label">Aktiviteter idag</div>
    <div class="today-number" id="Annan_folkbildning">–</div>
    <div class="percent-label">Procent av målet</div>
    <div class="percent-number" id="Annan_folkbildning_percent">–</div>
  </section>

  <div id="errors" aria-live="polite"></div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRo4L7NM3fPRZRuNrsQrVHAiUtvV18c61psxi3vxCIk9BvHfgToBOhL9tEnXYpCo5vbLvrGouVhLwUe/pub?output=csv";

    const goals = {
      "Studiecirklar": 1000,
      "Kulturprogram": 1000,
      "Annan_folkbildning": 500
    };

    function sanitizeKey(s){
      return (s || "")
        .replace(/\uFEFF/g,'')
        .trim()
        .replace(/[^a-zA-Z0-9åäöÅÄÖ]/g, '_');
    }

    function parseCSV(text){
      const rows = [];
      let cur = ""; let row = []; let inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i]; const next = text[i+1];
        if (inQuotes) {
          if (ch === '"') {
            if (next === '"') { cur += '"'; i++; }
            else { inQuotes = false; }
          } else { cur += ch; }
        } else {
          if (ch === '"') { inQuotes = true; }
          else if (ch === ',') { row.push(cur); cur = ""; }
          else if (ch === '\r') { continue; }
          else if (ch === '\n') { row.push(cur); rows.push(row); row = []; cur = ""; }
          else { cur += ch; }
        }
      }
      if (inQuotes === false && (cur !== "" || row.length)) {
        row.push(cur); rows.push(row);
      }
      return rows;
    }

    function showError(msg){
      document.getElementById('errors').textContent = msg;
      console.error(msg);
    }

    function loadData(){
      fetch(csvUrl)
        .then(r => { if (!r.ok) throw new Error("Nätverksfel: " + r.status + " " + r.statusText); return r.text(); })
        .then(text => {
          if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
          const rows = parseCSV(text);
          if (!rows || rows.length < 1) { showError("Kunde inte läsa CSV (tomt)."); return; }
          const header = rows[0].map(h => (h||"").replace(/\uFEFF/g,'').trim());
          const typIndex = header.findIndex(h => h.toLowerCase() === "typ");
          const antalIndex = header.findIndex(h => h.toLowerCase() === "antal");
          if (typIndex === -1 || antalIndex === -1) { showError("Hittar inte kolumnerna 'Typ' och 'Antal'."); return; }

          for (let i = 1; i < rows.length; i++) {
            const r = rows[i]; if (!r || r.length === 0) continue;
            const typ = (r[typIndex] || "").trim();
            const antal = parseInt((r[antalIndex] || "0").trim(), 10);
            if (!typ) continue;
            const id = sanitizeKey(typ);
            const el = document.getElementById(id);
            const percentEl = document.getElementById(id + "_percent");
            if (el) {
              el.textContent = antal;
              if (goals[id]) {
                const percent = Math.round((antal / goals[id]) * 100);
                if (percentEl) percentEl.textContent = percent + "%";
              }
            }
          }
        })
        .catch(err => { showError("Fel vid hämtning/parsing: " + err.message); });
    }

    document.addEventListener("DOMContentLoaded", loadData);
  </script>
</body>
</html>
