<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Statistik från Google Sheets</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; color:#333; text-align:center; padding:40px;}
    h2 { color:#004080; margin:18px 0 6px; font-size:2rem;}
    .stat { font-size:1.2rem; margin-bottom:28px; }
    .number { font-weight:700; color:#cc0000; font-size:1.5rem; display:inline-block; min-width:60px; }
    #errors { color:#900; margin-top:20px; }
  </style>
</head>
<body>
  <h2>1000 Studiecirklar</h2>
  <div class="stat">Just nu har vi gjort <span class="number" id="Studiecirklar">–</span> studiecirklar.</div>

  <h2>1000 Kulturprogram</h2>
  <div class="stat">Just nu har vi gjort <span class="number" id="Kulturprogram">–</span> kulturprogram.</div>

  <h2>500 Annan folkbildning</h2>
  <div class="stat">Just nu har vi gjort <span class="number" id="Annan_folkbildning">–</span> aktiviteter.</div>

  <div id="errors" aria-live="polite"></div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRo4L7NM3fPRZRuNrsQrVHAiUtvV18c61psxi3vxCIk9BvHfgToBOhL9tEnXYpCo5vbLvrGouVhLwUe/pub?output=csv";

function sanitizeKey(s){
  return (s || "")
    .replace(/\uFEFF/g,'')      // ta bort BOM om det finns
    .trim()
    .replace(/[^a-zA-Z0-9åäöÅÄÖ]/g, '_'); // ersätt mellanslag/specialtecken med _
}

// Enkel, robust CSV-parser (hanterar citationstecken och dubbla citationstecken)
function parseCSV(text){
  const rows = [];
  let cur = "";
  let row = [];
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i+1];

    if (inQuotes) {
      if (ch === '"') {
        if (next === '"') { cur += '"'; i++; } // escaped quote
        else { inQuotes = false; }
      } else {
        cur += ch;
      }
    } else {
      if (ch === '"') { inQuotes = true; }
      else if (ch === ',') { row.push(cur); cur = ""; }
      else if (ch === '\r') { continue; }
      else if (ch === '\n') { row.push(cur); rows.push(row); row = []; cur = ""; }
      else { cur += ch; }
    }
  }
  // push remainder
  if (inQuotes === false && (cur !== "" || row.length)) {
    row.push(cur);
    rows.push(row);
  }
  return rows;
}

function showError(msg){
  document.getElementById('errors').textContent = msg;
  console.error(msg);
}

function loadData(){
  fetch(csvUrl)
    .then(r => {
      if (!r.ok) throw new Error("Nätverksfel: " + r.status + " " + r.statusText);
      return r.text();
    })
    .then(text => {
      // ta bort BOM om den finns
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

      const rows = parseCSV(text);
      if (!rows || rows.length < 1) { showError("Kunde inte läsa CSV (tomt). Kontrollera att arket är publicerat."); return; }

      const header = rows[0].map(h => (h||"").replace(/\uFEFF/g,'').trim());
      const typIndex = header.findIndex(h => h.toLowerCase() === "typ");
      const antalIndex = header.findIndex(h => h.toLowerCase() === "antal");

      if (typIndex === -1 || antalIndex === -1) {
        showError("Hittar inte kolumnerna 'Typ' och 'Antal' i första raden. Kontrollera rubrikerna i arket.");
        return;
      }

      // Processa rader
      for (let i = 1; i < rows.length; i++) {
        const r = rows[i];
        if (!r || r.length === 0) continue;
        const typ = (r[typIndex] || "").trim();
        const antal = (r[antalIndex] || "").trim();
        if (!typ) continue;
        const id = sanitizeKey(typ);
        const el = document.getElementById(id);
        if (el) el.textContent = antal;
        else console.warn("Saknar element för:", typ, " → förväntat id:", id);
      }
    })
    .catch(err => {
      showError("Fel vid hämtning/parsing: " + err.message);
    });
}

document.addEventListener("DOMContentLoaded", loadData);
</script>
</body>
</html>
