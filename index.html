<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Statistik från Google Sheets</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; color:#333; text-align:center; padding:40px;}
    h2 { color:#004080; margin:18px 0 6px; font-size:2rem;}
    .stat { font-size:1.2rem; margin-bottom:28px; }
    .number { font-weight:700; color:#cc0000; font-size:1.5rem; display:inline-block; min-width:60px; }
    #errors { color:#900; margin-top:20px; }
  </style>
</head>
<body>
  <h2>1000 Studiecirklar</h2>
  <div class="stat">
    Just nu har vi gjort <span class="number" id="Studiecirklar">–</span> studiecirklar. 
    <span class="percent" id="percent_Studiecirklar"></span>
  </div>

  <h2>1000 Kulturprogram</h2>
  <div class="stat">
    Just nu har vi gjort <span class="number" id="Kulturprogram">–</span> kulturprogram. 
    <span class="percent" id="percent_Kulturprogram"></span>
  </div>

  <h2>500 Annan folkbildning</h2>
  <div class="stat">
    Just nu har vi gjort <span class="number" id="Annan_folkbildning">–</span> aktiviteter. 
    <span class="percent" id="percent_Annan_folkbildning"></span>
  </div>

  <div id="errors" aria-live="polite"></div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRo4L7NM3fPRZRuNrsQrVHAiUtvV18c61psxi3vxCIk9BvHfgToBOhL9tEnXYpCo5vbLvrGouVhLwUe/pub?output=csv";

// Definiera målen för varje typ
const goals = {
  Studiecirklar: 1000,
  Kulturprogram: 1000,
  Annan_folkbildning: 500
};

function sanitizeKey(s){
  return (s || "")
    .replace(/\uFEFF/g,'')      // ta bort BOM om det finns
    .trim()
    .replace(/[^a-zA-Z0-9åäöÅÄÖ]/g, '_'); // ersätt mellanslag/specialtecken med _
}

// Enkel CSV-parser
function parseCSV(text){
  const rows = [];
  let cur = "", row = [], inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i], next = text[i+1];
    if (inQuotes) {
      if (ch === '"') { if(next === '"'){cur+='"'; i++;} else {inQuotes=false;} } 
      else { cur+=ch; }
    } else {
      if (ch === '"'){inQuotes=true;}
      else if (ch === ','){row.push(cur); cur="";}
      else if (ch === '\r'){continue;}
      else if (ch === '\n'){row.push(cur); rows.push(row); row=[]; cur="";}
      else{cur+=ch;}
    }
  }
  if(!inQuotes && (cur!==""||row.length)) { row.push(cur); rows.push(row);}
  return rows;
}

function showError(msg){
  document.getElementById('errors').textContent = msg;
  console.error(msg);
}

function loadData(){
  fetch(csvUrl)
    .then(r => { if(!r.ok) throw new Error("Nätverksfel: "+r.status+" "+r.statusText); return r.text(); })
    .then(text => {
      if (text.charCodeAt(0)===0xFEFF) text=text.slice(1);
      const rows=parseCSV(text);
      if(!rows||rows.length<1){showError("Kunde inte läsa CSV (tomt). Kontrollera att arket är publicerat."); return;}
      const header=rows[0].map(h=>(h||"").replace(/\uFEFF/g,'').trim());
      const typIndex=header.findIndex(h=>h.toLowerCase()==="typ");
      const antalIndex=header.findIndex(h=>h.toLowerCase()==="antal");
      if(typIndex===-1||antalIndex===-1){showError("Hittar inte kolumnerna 'Typ' och 'Antal'."); return;}

      for(let i=1;i<rows.length;i++){
        const r=rows[i]; if(!r||r.length===0) continue;
        const typ=(r[typIndex]||"").trim();
        const antal=(r[antalIndex]||"").trim();
        if(!typ) continue;
        const id=sanitizeKey(typ);
        const el=document.getElementById(id);
        if(el) el.textContent=antal;

        // Räkna procent och skriv ut
        const percentEl=document.getElementById("percent_"+id);
        if(percentEl && goals[id]){
          const pct=Math.round((parseInt(antal)/goals[id])*100);
          percentEl.textContent=` Det är ${pct}% av målet.`;
        }
      }
    })
    .catch(err=>showError("Fel vid hämtning/parsing: "+err.message));
}

document.addEventListener("DOMContentLoaded", loadData);
</script>
</body>
</html>
